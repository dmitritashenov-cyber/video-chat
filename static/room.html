<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Video Room</title>
</head>
<body>

<h2>Video Room</h2>

<p>Share this link with your friend:</p>
<input id="link" style="width:80%" readonly>

<br><br>

<video id="localVideo" autoplay muted playsinline style="width:45%;border:1px solid black;"></video>
<video id="remoteVideo" autoplay playsinline style="width:45%;border:1px solid black;"></video>

<script>
const room = new URLSearchParams(window.location.search).get("room");
document.getElementById("link").value = location.href;

// ws / wss auto
const protocol = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${protocol}://${location.host}/ws/${room}`);

let pc;
let localStream;

const iceConfig = {
  iceServers: [
    {
      urls: [
        "turn:openrelay.metered.ca:80",
        "turn:openrelay.metered.ca:443",
        "turn:openrelay.metered.ca:3478"
      ],
      username: "openrelayproject",
      credential: "openrelayproject"
    },
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

async function start() {
    localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    });

    document.getElementById("localVideo").srcObject = localStream;

    pc = new RTCPeerConnection(iceConfig);

    localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
    });

    pc.ontrack = event => {
        document.getElementById("remoteVideo").srcObject = event.streams[0];
    };

    pc.onicecandidate = event => {
        if (event.candidate) {
            ws.send(JSON.stringify({
                type: "ice",
                candidate: event.candidate
            }));
        }
    };
}

ws.onmessage = async (msg) => {
    const data = JSON.parse(msg.data);

    if (data.type === "offer") {
        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", answer }));
    }

    if (data.type === "answer") {
        await pc.setRemoteDescription(data.answer);
    }

    if (data.type === "ice") {
        try {
            await pc.addIceCandidate(data.candidate);
        } catch (e) {
            console.error(e);
        }
    }
};

ws.onopen = async () => {
    await start();
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type: "offer", offer }));
};
</script>

</body>
</html>
