<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Video Room</title>
</head>
<body>

<h2>Video Room</h2>

<p>Share this link:</p>
<input id="link" style="width:80%" readonly value="">

<br><br>

<video id="localVideo" autoplay muted playsinline style="width:45%;border:1px solid black;"></video>
<video id="remoteVideo" autoplay playsinline style="width:45%;border:1px solid black;"></video>

<script>
const room = new URLSearchParams(window.location.search).get("room");
document.getElementById("link").value = location.href;

const protocol = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${protocol}://${location.host}/ws/${room}`);

let pc;
let localStream;
let makingOffer = false;
let ignoreOffer = false;
let polite = true;
let pendingCandidates = [];

const iceConfig = {
  iceServers: [
    {
      urls: [
        "turn:openrelay.metered.ca:80",
        "turn:openrelay.metered.ca:443",
        "turn:openrelay.metered.ca:3478"
      ],
      username: "openrelayproject",
      credential: "openrelayproject"
    },
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

async function start() {
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById("localVideo").srcObject = localStream;

    pc = new RTCPeerConnection(iceConfig);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];

    pc.onicecandidate = ({candidate}) => {
        if (candidate) ws.send(JSON.stringify({type:"ice", candidate}));
    };

    pc.onnegotiationneeded = async () => {
        try {
            makingOffer = true;
            await pc.setLocalDescription(await pc.createOffer());
            ws.send(JSON.stringify({type:"offer", offer: pc.localDescription}));
        } catch(e){console.error(e)}
        finally{makingOffer=false;}
    };
}

ws.onmessage = async msg => {
    const data = JSON.parse(msg.data);
    try{
        if(data.type==="offer"){
            const offerCollision = makingOffer || pc.signalingState!=="stable";
            ignoreOffer = !polite && offerCollision;
            if(ignoreOffer) return;

            await pc.setRemoteDescription(data.offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({type:"answer", answer:pc.localDescription}));

            for(const c of pendingCandidates) await pc.addIceCandidate(c);
            pendingCandidates = [];
        }

        if(data.type==="answer") await pc.setRemoteDescription(data.answer);
        if(data.type==="ice"){
            if(pc.remoteDescription) await pc.addIceCandidate(data.candidate);
            else pendingCandidates.push(data.candidate);
        }
    } catch(e){console.error("Signal error",e)}
};

ws.onopen = async () => { await start(); };
</script>

</body>
</html>
